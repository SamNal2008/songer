name: CI Backend

on:
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/ci-backend.yml"

jobs:
  test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/pyproject.toml
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run ruff (linting)
        run: ruff check .
      
      - name: Run mypy (type checking)
        run: mypy .
      
      - name: Run pytest with coverage
        run: pytest --cov=songer_backend --cov-report=xml --cov-report=term-missing
      
      - name: Coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coveragePath = 'backend/coverage.xml';
            
            if (fs.existsSync(coveragePath)) {
              const coverage = fs.readFileSync(coveragePath, 'utf8');
              // Extract coverage percentage from XML
              const match = coverage.match(/line-rate="([^"]+)"/);
              const coveragePercent = match ? (parseFloat(match[1]) * 100).toFixed(2) : 0;
              
              const comment = `## ðŸ“Š Backend Coverage Report\n\nCoverage: ${coveragePercent}%\n\n`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              if (parseFloat(coveragePercent) < 80) {
                core.setFailed(`Coverage is below 80%: ${coveragePercent}%`);
              }
            }
      
      - name: Start FastAPI server for health check
        run: |
          # Create test .env file
          cat > .env << EOF
          SUPABASE_URL=https://test.supabase.co
          SUPABASE_ANON_KEY=test_key
          SUPABASE_SERVICE_KEY=test_service_key
          BACKEND_SECRET_KEY=test_secret_key
          EOF
          
          # Start server in background
          uvicorn songer_backend.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
      
      - name: Test health endpoint
        run: |
          curl -f http://localhost:8000/api/health || exit 1
      
      - name: Add label
        uses: actions/github-script@v7
        with:
          script: |
            const label = job.status === 'success' ? 'backend-ok' : 'backend-failing';
            
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            });
