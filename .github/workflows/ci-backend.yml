name: CI Backend

on:
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/ci-backend.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
          
      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          
      - name: Run ruff (linting)
        run: |
          cd backend
          ruff check .
        continue-on-error: true
        
      - name: Run mypy (type checking)
        run: |
          cd backend
          mypy .
        continue-on-error: true
        
      - name: Run pytest with coverage
        run: |
          cd backend
          pytest --cov=. --cov-report=json --cov-report=term-missing
          
      - name: Coverage check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('backend/coverage.json', 'utf8'));
              const total = coverage.totals;
              const lines = total.percent_covered;
              
              const comment = `## üìä Backend Coverage Report
              - Coverage: ${lines.toFixed(2)}%
              
              ${lines >= 80 ? '‚úÖ Coverage threshold passed (80%)' : '‚ùå Coverage below threshold (80%)'}`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              if (lines < 80) {
                core.setFailed('Coverage below 80%');
              }
            } catch (e) {
              console.log('Could not read coverage report');
            }
            
      - name: Test health endpoint
        run: |
          cd backend
          # Install uvicorn if not present
          pip install uvicorn fastapi
          # Start server in background
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          # Test health endpoint
          curl -f http://localhost:8000/health || curl -f http://localhost:8000/api/health || echo "Health endpoint not found"
          # Stop server
          pkill -f uvicorn || true
        continue-on-error: true
        
      - name: Label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const hasBackendOk = labels.some(l => l.name === 'backend-ok');
            const hasBackendFailing = labels.some(l => l.name === 'backend-failing');
            
            if (hasBackendOk) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'backend-ok'
              });
            }
            
            if (hasBackendFailing) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'backend-failing'
              });
            }
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [process.exitCode === 0 ? 'backend-ok' : 'backend-failing']
            });
