name: Issue to Agent Routing

on:
  issues:
    types: [labeled, closed]

jobs:
  handle-codex:
    if: github.event.label.name == 'codex'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assign to Codex
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.replace(/\s+/g, '-').toLowerCase().substring(0, 50);
            const branchName = `feature/issue-${issue.number}-${title}`;

            // Get the default branch SHA
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // Create branch
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: repo.default_branch === 'main' ? repo.commit.sha : repo.commit.sha
            });

            // Add in-progress label
            await github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['in-progress']
            });

            // Post comment
            await github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Codex is picking up this task...
              
              Branch created: \`${branchName}\`
              
              Codex will start working on this issue shortly.`
            });

  handle-claude:
    if: github.event.label.name == 'claude'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assign to Claude
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.replace(/\s+/g, '-').toLowerCase().substring(0, 50);
            const branchName = `feature/issue-${issue.number}-${title}`;

            // Get the default branch SHA
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // Create branch
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: repo.commit.sha
            });

            // Add in-progress label
            await github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['in-progress']
            });

            // Post comment
            await github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§  Claude Code is picking up this task...
              
              Branch created: \`${branchName}\`
              
              Claude will start working on this issue shortly.`
            });

  handle-feedback:
    if: github.event.label.name == 'feedback'
    runs-on: ubuntu-latest
    steps:
      - name: Get related PRs and commits
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Get PRs that reference this issue
            const { data: prs } = await github.rest.search.issuesAndPullRequests({
              q: `${issue.number} repo:${context.repo.owner}/${context.repo.repo} type:pr`
            });

            // Get commits that reference this issue
            const { data: commits } = await github.rest.search.commits({
              q: `${issue.number} repo:${context.repo.owner}/${context.repo.repo}`
            });

            let comment = `## ðŸ“ Feedback Requested\n\n`;

            if (prs.items.length > 0) {
              comment += `### Related Pull Requests:\n`;
              prs.items.forEach(pr => {
                comment += `- #${pr.number} - ${pr.title}\n`;
              });
            }

            if (commits.items.length > 0) {
              comment += `\n### Related Commits:\n`;
              commits.items.slice(0, 5).forEach(commit => {
                comment += `- ${commit.sha.substring(0, 7)} - ${commit.commit.message.split('\n')[0]}\n`;
              });
            }

            if (prs.items.length === 0 && commits.items.length === 0) {
              comment += `No PRs or commits found referencing this issue.`;
            }

            await github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            // Add needs-revision label
            await github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['needs-revision']
            });

  handle-closed:
    if: github.event.action == 'closed' && context.payload.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Get PRs that reference this issue
            const { data: prs } = await github.rest.search.issuesAndPullRequests({
              q: `${issue.number} repo:${context.repo.owner}/${context.repo.repo} type:pr is:merged`
            });

            if (prs.items.length > 0) {
              const pr = prs.items[0];
              
              // Post shipped comment
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âœ… Shipped in PR #${pr.number}
                
                ${pr.title}
                
                This issue has been automatically closed as the associated PR was merged.`
              });
              
              // Update labels
              await github.rest.issues.removeLabel({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'in-progress'
              });
              
              await github.rest.issues.addLabels({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['done']
              });
            }
