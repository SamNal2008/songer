name: CI Frontend

on:
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/ci-frontend.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          
      - name: Run ESLint
        run: |
          cd frontend
          npm run lint
        continue-on-error: true
        
      - name: Type check
        run: |
          cd frontend
          npm run type-check
          
      - name: Run tests with coverage
        run: |
          cd frontend
          npm run test:coverage
          
      - name: Coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = fs.readFileSync('frontend/coverage/coverage-summary.json', 'utf8');
              const data = JSON.parse(coverage);
              const lines = data.total.lines.pct;
              const functions = data.total.functions.pct;
              const branches = data.total.branches.pct;
              const statements = data.total.statements.pct;
              
              const comment = `## üìä Frontend Coverage Report
              - Lines: ${lines}%
              - Functions: ${functions}%
              - Branches: ${branches}%
              - Statements: ${statements}%
              
              ${lines >= 80 ? '‚úÖ Coverage threshold passed (80%)' : '‚ùå Coverage below threshold (80%)'}`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              if (lines < 80) {
                core.setFailed('Coverage below 80%');
              }
            } catch (e) {
              console.log('Could not read coverage report');
            }
            
      - name: Build Next.js app
        run: |
          cd frontend
          npm run build
          
      - name: Label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const hasFrontendOk = labels.some(l => l.name === 'frontend-ok');
            const hasFrontendFailing = labels.some(l => l.name === 'frontend-failing');
            
            if (hasFrontendOk) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'frontend-ok'
              });
            }
            
            if (hasFrontendFailing) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'frontend-failing'
              });
            }
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [process.exitCode === 0 ? 'frontend-ok' : 'frontend-failing']
            });
