name: CI Model

on:
  pull_request:
    paths:
      - 'model/**'
      - '.github/workflows/ci-model.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: model/requirements.txt
          
      - name: Install dependencies
        run: |
          cd model
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
          
      - name: Run tests
        run: |
          cd model
          # Check if tests exist
          if [ -d "tests" ]; then
            pytest tests/ -v
          else
            echo "âš ï¸ Model tests not yet configured"
            echo "Creating placeholder test..."
            mkdir -p tests
            cat > tests/test_placeholder.py << 'EOF'
            def test_placeholder():
                """Placeholder test that always passes."""
                assert True
            EOF
            pytest tests/ -v
          fi
          
      - name: Post comment about model status
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const comment = `## ðŸ¤– Model Service Status
            âš ï¸ Model layer is in development and not yet production-ready.
            
            Tests passed but this service does not block PR merges.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: Label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const hasModelOk = labels.some(l => l.name === 'model-ok');
            const hasModelPending = labels.some(l => l.name === 'model-pending');
            
            if (hasModelOk) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'model-ok'
              });
            }
            
            if (hasModelPending) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'model-pending'
              });
            }
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['model-ok']
            });
