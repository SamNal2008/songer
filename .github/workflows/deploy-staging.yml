name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      model: ${{ steps.changes.outputs.model }}
      supabase: ${{ steps.changes.outputs.supabase }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            model:
              - 'model/**'
            supabase:
              - 'supabase/**'

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy backend
        run: |
          echo "âš ï¸ Backend deploy target not configured"
          echo "TODO: Add your deployment logic here"
          echo "Examples:"
          echo "  - Deploy to AWS ECS"
          echo "  - Deploy to Google Cloud Run"
          echo "  - Deploy to Railway"
          echo "  - Deploy to Heroku"

  deploy-model:
    needs: detect-changes
    if: needs.detect-changes.outputs.model == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy model service
        run: |
          echo "âš ï¸ Model service is not production-ready"
          echo "Skipping deployment until model is finalized"

  deploy-supabase:
    needs: detect-changes
    if: needs.detect-changes.outputs.supabase == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run migrations
        run: |
          if [ -d supabase/migrations ]; then
            cd supabase
            supabase db push --linked
          else
            echo "No migrations found"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  notify:
    needs: [deploy-frontend, deploy-backend, deploy-model, deploy-supabase]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Notify deployment
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = '${{ steps.commit.outputs.sha }}'.substring(0, 7);
            const comment = `## ğŸš€ Deployed to Staging
            Commit: ${commitSha}

            Services deployed:
            - Frontend: ${{ needs.deploy-frontend.result == 'success' && 'âœ…' || 'â­ï¸' }}
            - Backend: ${{ needs.deploy-backend.result == 'success' && 'âœ…' || needs.deploy-backend.result == 'failure' && 'âŒ' || 'â­ï¸' }}
            - Model: ${{ needs.deploy-model.result == 'success' && 'âœ…' || 'â­ï¸' }}
            - Supabase: ${{ needs.deploy-supabase.result == 'success' && 'âœ…' || needs.deploy-supabase.result == 'failure' && 'âŒ' || 'â­ï¸' }}`;

            // Create GitHub comment
            github.rest.issues.createComment({
              issue_number: context.issue.number || 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            // Optional: Send to Slack
            // TODO: Add Slack webhook if needed
